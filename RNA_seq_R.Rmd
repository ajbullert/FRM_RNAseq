---
title: "RNAseq Differential Expression Fox River Mixture"
output:
  pdf_document: default
  html_notebook: default
---
```{r}
BiocManager::install("Mus.musculus")
BiocManager::install("enrichplot")
BiocManager::install("clusterProfiler")
BiocManager::install("scRNAseq")
BiocManager::install("SingleCellExperiment")
BiocManager::install("TOAST")
devtools::install_github('xuranw/MuSiC')
remotes::install_github("renozao/xbioc")

# install the MuSiC2 package
if (!"MuSiC2" %in% rownames(installed.packages())) {
  devtools::install_github('Jiaxin-Fan/MuSiC2')
}
```


The majority of Library packages are listed here. If you want to include more just install and load at the end of the list. If code isn't recognizing the function, it is likely that R didn't load the package that the function comes from.
#load libraries every time
```{r, results='hide'}
library(ggplot2)
library(devtools)
library(rgl)
library(tidyverse)
library(tidyr)
library(RColorBrewer)
library(expss)
library(dplyr)
library(BiocManager)
library(RMariaDB)
library(GenomicAlignments)
library(BiocParallel)
library(GenomicFeatures)
library(DESeq2)
library(Mus.musculus)
library(Rsamtools)
library(pheatmap)
library(topGO)
library(gridExtra)
library(AnnotationDbi)
library(org.Mm.eg.db)
library(EnhancedVolcano)
library(TxDb.Mmusculus.UCSC.mm10.knownGene)
library(enrichplot)
library(clusterProfiler)
library(pathview)
library(readr)
library(MuSiC2)
library(ggpubr)
library(ggsignif)
library(rstatix)
library(scRNAseq)
library(VennDiagram)
library(stringr)
library(tibble)
```

Set your working directory and pull in your reference genome to compare your samples to. We will read the gene model from an Ensembl GTF file. Be sure your gene model reflects the same model used in your samples. 

***Define the Gene Model***
```{r}
TxDb<-makeTxDbFromUCSC(genome = "mm10",
                        tablename ="knownGene", 
                        goldenPath.url = getOption("UCSC.goldenPath.url"))
```

For additional notes reference "https://www.bioconductor.org/help/course-materials/2016/CSAMA/lab-3-rnaseq/rnaseq_gene_CSAMA2016.html"

The following line produces a GRangesList of all the exons grouped by gene (Lawrence et al. 2013). Each element of the list is a GRanges object of the exons for a gene
```{r}
ebg <- exonsBy(TxDb, 
               by="gene")
ebg
g_ids<-names(ebg)
```

Now that our gene model reference is ready we can load in samples and analyze them accordingly. I found separating by tissue type was easiest. But it can also be helpful to load all samples together. 

***Liver Samples***
```{r}
info<- read.csv(file = "RNA-seq_metadata.csv", #reading in the sample information
                   header = T, 
                   sep = ",")

filenames <- file.path("P:/OEH/Faculty/hlehmler/research/Lehmler Group-Amanda Bullert/RNAseq/fastq_files/BAM_files/", 
                           info$bam_id)
file.exists(filenames) #a sanity check to make sure you have files named
```

Next specify the details about how the BAM files should be treated in R, e.g., only process 2 million reads at a time. This can be modified to your computing limitations.
```{r}
bamfiles <- BamFileList(filenames, 
                            yieldSize=2000000)
seqinfo(bamfiles)
```

#***Counting***
```{r}

se <- summarizeOverlaps(features=ebg, #define the gene reference
                            reads=bamfiles, #samples to be read
                            mode="Union", 
                            singleEnd=FALSE, #False indicates samples are paired-end
                            ignore.strand=FALSE, #not a strand specific experiment
                            BPPARAM= SerialParam(progressbar = TRUE)) #progress bar shown
se
head(assay(se)) #access the counts
str(metadata(rowRanges(se))) #just to look a the structure of data

```


#proceed here (no need to recount summarized experiments)

```{r}
colData(se) #metadata about the samples
colData(se)<-DataFrame(info) #take the sample info and assign it as the metadata
se$Treatment<- as.factor(se$Treatment) #organizing structure of groups
se$Treatment1<- relevel(se$Treatment, 
                           "WT_VEH") # tells the system which group is "control"
se$Treatment2<- relevel(se$Treatment, 
                           "WT_PCB6") # tells the system which group is "control"
se$Treatment3<- relevel(se$Treatment, 
                           "WT_PCB30") # tells the system which group is "control"
se <- se[ rowSums(assay(se)) >= 10, ] #remove genes that have a total count less than 10, a good prefilter measure
```

#***Using DeSeq2***
We can now construct a DESeqDataSet object to formulate a starting point for our analysis. You need to add an appropriate design for analysis
```{r}
dds <- DESeqDataSet(se, 
                    design = ~ Treatment1) 

dds2 <- DESeqDataSet(se, 
                    design = ~ Treatment2) 

dds3 <- DESeqDataSet(se, 
                    design = ~ Treatment3) 
```

#***Exploratory analysis and visualization***
*transformations*
The variance stabilizing transformation (VST) a goal of stablizing the variance across the range of values. produce log2-like values for high counts. 
```{r}
vsd <- vst(dds)
```

#results
#***Differential Expression***
Lets run a differential expression pipeline using the raw counts

This function will print out a message for the various steps it performs. These are described in more detail in the manual page for DESeq, which can be accessed by typing ?DESeq. Briefly these are: the estimation of size factors (controlling for differences in the sequencing depth of the samples), the estimation of dispersion values for each gene, and fitting a generalized linear model.
```{r}
dds <- DESeq(dds)
dds2 <- DESeq(dds2)
dds3 <- DESeq(dds3)

resultsNames(dds3)
res1<-results(dds, name="Treatment1_GF_VEH_vs_WT_VEH")
res2<-results(dds2, name="Treatment2_GF_PCB6_vs_WT_PCB6")
res3<-results(dds3, name="Treatment3_GF_PCB30_vs_WT_PCB30")
#res4<-results(dds, name="Treatment_GF_PCB30_vs_GF_VEH")
#res5<-results(dds, name="Treatment_GF_PCB6_vs_GF_VEH")
#res6<-results(dds, name="Treatment_WT_PCB6_vs_WT_VEH")
#res7<-results(dds, name="Treatment_WT_PCB30_vs_WT_VEH")
```
Calling results without any arguments will extract the estimated log2 fold changes and p values for the last variable in the design formula. If there are more than 2 levels for this variable, results will extract the results table for a comparison of the last level over the first level. Treatment 6 vs vehicle
```{r}
summary(res1)
summary(res2)
summary(res3)
```


#***Annotating results***

How to assign actual gene names to our counts. Using an annotation package for Mus musculus. 
```{r}
res1$symbol <- mapIds(Mus.musculus, #which annotation package model to use
                     keys=row.names(res1), #using rownames
                     column="SYMBOL", #add a column of symbols associated with row.names arguments for the model
                     keytype="GENEID", #our rownames are gene id's 
                     multiVals="first")
res2$symbol <- mapIds(Mus.musculus, #which annotation package model to use
                     keys=row.names(res2), #using rownames
                     column="SYMBOL", #add a column of symbols associated with row.names arguments for the model
                     keytype="GENEID", #our rownames are gene id's 
                     multiVals="first")
res3$symbol <- mapIds(Mus.musculus, #which annotation package model to use
                     keys=row.names(res3), #using rownames
                     column="SYMBOL", #add a column of symbols associated with row.names arguments for the model
                     keytype="GENEID", #our rownames are gene id's 
                     multiVals="first")

```

```{r}
res1$TXname <- mapIds(Mus.musculus, #which annotation package model to use
                     keys=row.names(res1), #using rownames
                     column="TXNAME", #add a column of symbols associated with row.names arguments for the model
                     keytype="GENEID", #our rownames are gene id's 
                     multiVals="first")
res2$TXname <- mapIds(Mus.musculus, #which annotation package model to use
                     keys=row.names(res2), #using rownames
                     column="TXNAME", #add a column of symbols associated with row.names arguments for the model
                     keytype="GENEID", #our rownames are gene id's 
                     multiVals="first")
res3$TXname <- mapIds(Mus.musculus, #which annotation package model to use
                     keys=row.names(res3), #using rownames
                     column="TXNAME", #add a column of symbols associated with row.names arguments for the model
                     keytype="GENEID", #our rownames are gene id's 
                     multiVals="first")

```

```{r}
res1$entrez <- mapIds(Mus.musculus,
                     keys=row.names(res1),
                     column="ENTREZID",
                     keytype="GENEID",
                     multiVals="first")
res2$entrez <- mapIds(Mus.musculus,
                     keys=row.names(res2),
                     column="ENTREZID",
                     keytype="GENEID",
                     multiVals="first")
res3$entrez <- mapIds(Mus.musculus,
                     keys=row.names(res3),
                     column="ENTREZID",
                     keytype="GENEID",
                     multiVals="first")
```

```{r}
res1$Genename <- mapIds(Mus.musculus,
                     keys=row.names(res1),
                     column="GENENAME", #now add a column for gene names or gene description
                     keytype="GENEID",
                     multiVals="first")
res2$Genename <- mapIds(Mus.musculus,
                     keys=row.names(res2),
                     column="GENENAME", #now add a column for gene names or gene description
                     keytype="GENEID",
                     multiVals="first")
res3$Genename <- mapIds(Mus.musculus,
                     keys=row.names(res3),
                     column="GENENAME", #now add a column for gene names or gene description
                     keytype="GENEID",
                     multiVals="first")
```

```{r}
res1$GOID <- mapIds(Mus.musculus,
                     keys=row.names(res1),
                     column="GO", #now add a column for gene names or gene description
                     keytype="GENEID",
                     multiVals="first")
res2$GOID <- mapIds(Mus.musculus,
                     keys=row.names(res2),
                     column="GO", #now add a column for gene names or gene description
                     keytype="GENEID",
                     multiVals="first")
res3$GOID <- mapIds(Mus.musculus,
                     keys=row.names(res3),
                     column="GO", #now add a column for gene names or gene description
                     keytype="GENEID",
                     multiVals="first")
```
```{r}
res1$ensembl <- mapIds(Mus.musculus,
                     keys=row.names(res1),
                     column="ENSEMBL", #now add a column for gene names or gene description
                     keytype="GENEID",
                     multiVals="first")
res2$ensembl <- mapIds(Mus.musculus,
                     keys=row.names(res2),
                     column="ENSEMBL", #now add a column for gene names or gene description
                     keytype="GENEID",
                     multiVals="first")
res3$ensembl <- mapIds(Mus.musculus,
                     keys=row.names(res3),
                     column="ENSEMBL", #now add a column for gene names or gene description
                     keytype="GENEID",
                     multiVals="first")
```


```{r}
write.csv( as.data.frame(res1), file="Results_spreadsheets/GF_veh_vs_WT_VEH_results.csv" )
write.csv( as.data.frame(res2), file="Results_spreadsheets/GF_PCB6_vs_WT_PCB6_results.csv" )
write.csv( as.data.frame(res3), file="Results_spreadsheets/GF_PCB30_vs_WT_PCB30_results.csv" )
```


```{r}
resOrdered1 <- res1[order(res1$padj),] #reorder the genes based on significance
resOrdered2 <- res2[order(res2$padj),] #reorder the genes based on significance
resOrdered3 <- res3[order(res3$padj),] #reorder the genes based on significance
```


#gene enrichment
```{r}
x<- res1[order(res1$log2FoldChange, decreasing = TRUE),] #reorder the genes based on significance
gene_list<-x$log2FoldChange
names(gene_list)<-x$ensembl
head(gene_list)
```

```{r}
gse <- gseGO(geneList=gene_list, 
             ont ="ALL", 
             keyType = "ENSEMBL", 
             nPerm = 10000, 
             minGSSize = 3, 
             maxGSSize = 800, 
             pvalueCutoff = 0.05, 
             verbose = TRUE, 
             OrgDb = org.Mm.eg.db, 
             pAdjustMethod = "none")

```

res1<-results(dds, name="Treatment1_GF_VEH_vs_WT_VEH")
res2<-results(dds2, name="Treatment2_GF_PCB6_vs_WT_PCB6")
res3<-results(dds3, name="Treatment3_GF_PCB30_vs_WT_PCB30")

```{r}
tiff(file = 'gene_enrichment/GF_VEH_VS_WT_VEH_enrichment.tiff', units="in", width=7, height=5, res=1000)
dot<-dotplot(gse, showCategory=10, split=".sign") +
  facet_grid(.~.sign)+
  ggtitle("Germ Free vs Wild type Vehicle Enrichment")+ theme(axis.text.y = element_text(size = 5))    

dot
dev.off()
dot
```

```{r}
x<- res2[order(res2$log2FoldChange, decreasing = TRUE),] #reorder the genes based on significance
gene_list<-x$log2FoldChange
names(gene_list)<-x$ensembl
head(gene_list)
```

```{r}
gse2 <- gseGO(geneList=gene_list, 
             ont ="ALL", 
             keyType = "ENSEMBL", 
             nPerm = 10000, 
             minGSSize = 3, 
             maxGSSize = 800, 
             pvalueCutoff = 0.05, 
             verbose = TRUE, 
             OrgDb = org.Mm.eg.db, 
             pAdjustMethod = "none")

```

```{r}
tiff(file = 'gene_enrichment/GF_PCB6_VS_WT_PCB6_enrichment.tiff', units="in", width=7, height=5, res=1000)
dot<-dotplot(gse2, showCategory=10, split=".sign") +
  facet_grid(.~.sign)+
  ggtitle("Germ Free vs Wild type 6 mg/kg Enrichment")+ theme(axis.text.y = element_text(size = 5))    

dot
dev.off()
dot
```

```{r}
x<- res3[order(res3$log2FoldChange, decreasing = TRUE),] #reorder the genes based on significance
gene_list<-x$log2FoldChange
names(gene_list)<-x$ensembl
head(gene_list)
```

```{r}
gse3 <- gseGO(geneList=gene_list, 
             ont ="ALL", 
             keyType = "ENSEMBL", 
             nPerm = 10000, 
             minGSSize = 3, 
             maxGSSize = 800, 
             pvalueCutoff = 0.05, 
             verbose = TRUE, 
             OrgDb = org.Mm.eg.db, 
             pAdjustMethod = "none")

```


```{r}
tiff(file = 'gene_enrichment/GF_PCB30_VS_WT_PCB30_enrichment.tiff', units="in", width=7, height=5, res=1000)
dot<-dotplot(gse3, showCategory=10, split=".sign") +
  facet_grid(.~.sign)+
  ggtitle("Germ Free vs Wild type 30 mg/kg Enrichment")+ theme(axis.text.y = element_text(size = 5))    

dot
dev.off()
dot
```

```{r}
data<-data.frame(gse)
data2<-data.frame(gse2)
data3<-data.frame(gse3)

write.csv(data ,file="gene_enrichment/GF_VEH_VS_WT_VEH_gene_enrichment.csv")
write.csv(data2 ,file="gene_enrichment/GF_PCB6_VS_WT_PCB6_gene_enrichment.csv")
write.csv(data3 ,file="gene_enrichment/GF_PCB30_VS_WT_PCB30_gene_enrichment.csv")
```


#KEGG pathview
```{r}
x<- res1[order(res1$log2FoldChange, decreasing = TRUE),] #reorder the genes based on significance
gene_list<-x$log2FoldChange
names(gene_list)<-x$entrez
head(gene_list)
```


```{r}
kegg_organism = "mmu"
kk2 <- gseKEGG(geneList     = gene_list,
               organism     = kegg_organism,
               nPerm        = 10000,
               minGSSize    = 3,
               maxGSSize    = 800,
               pvalueCutoff = 0.05,
               pAdjustMethod = "none",
               keyType       = "ncbi-geneid")
```

```{r}
tiff(file = 'KEGG_enrichment/GF_VEH_VS_WT_VEH_KEGG_enrichment.tiff', units="in", width=8, height=5, res=1000)
dot<-dotplot(kk2, showCategory=5, split=".sign") +
  facet_grid(.~.sign)+
  ggtitle("Germ Free vs Wild Type Vehichle KEGG Enrichment")+ theme(axis.text.y = element_text(size = 5))

dot
dev.off()
dot
```

```{r}
x<- res2[order(res2$log2FoldChange, decreasing = TRUE),] #reorder the genes based on significance
gene_list<-x$log2FoldChange
names(gene_list)<-x$entrez
head(gene_list)
```


```{r}
kegg_organism = "mmu"
kk3 <- gseKEGG(geneList     = gene_list,
               organism     = kegg_organism,
               nPerm        = 10000,
               minGSSize    = 3,
               maxGSSize    = 800,
               pvalueCutoff = 0.05,
               pAdjustMethod = "none",
               keyType       = "ncbi-geneid")
```

```{r}
tiff(file = 'KEGG_enrichment/GF_PCB6_VS_WT_PCB6_KEGG_enrichment.tiff', units="in", width=8, height=5, res=1000)
dot<-dotplot(kk3, showCategory=5, split=".sign") +
  facet_grid(.~.sign)+
  ggtitle("Germ Free vs Wild Type 6 mg/kg KEGG Enrichment")+ theme(axis.text.y = element_text(size = 5))

dot
dev.off()
dot
```

```{r}
x<- res3[order(res3$log2FoldChange, decreasing = TRUE),] #reorder the genes based on significance
gene_list<-x$log2FoldChange
names(gene_list)<-x$entrez
head(gene_list)
```


```{r}
kegg_organism = "mmu"
kk4 <- gseKEGG(geneList     = gene_list,
               organism     = kegg_organism,
               nPerm        = 10000,
               minGSSize    = 3,
               maxGSSize    = 800,
               pvalueCutoff = 0.05,
               pAdjustMethod = "none",
               keyType       = "ncbi-geneid")
```

```{r}
tiff(file = 'KEGG_enrichment/GF_PCB30_VS_WT_PCB30_KEGG_enrichment.tiff', units="in", width=8, height=5, res=1000)
dot<-dotplot(kk4, showCategory=5, split=".sign") +
  facet_grid(.~.sign)+
  ggtitle("Germ Free vs Wild Type 30 mg/kg KEGG Enrichment")+ theme(axis.text.y = element_text(size = 5))

dot
dev.off()
dot
```
```{r}
df<-data.frame(kk2)
df2<-data.frame(kk3)
df3<-data.frame(kk4)

write.csv(df ,file="KEGG_enrichment/GF_VEH_VS_WT_VEH_KEGG_enrichment.csv")
write.csv(df2 ,file="KEGG_enrichment/GF_PCB6_VS_WT_PCB6_KEGG_enrichment.csv")
write.csv(df3 ,file="KEGG_enrichment/GF_PCB30_VS_WT_PCB30_KEGG_enrichment.csv")
```



#plotting individual genes of interest (Liver)
Using normalized counts (prebuilt into DESEQ2) which normalizes counts by the estimated size factors (or normalization factors if these were used) and adds a pseudocount of 1/2 to allow for log scale plotting.
**drug metabolizing enzymes**
```{r}
top_gene<-read.csv("gene_list_drug_metabolizing_kegg.csv", header = FALSE)
top_gene<-as.character(top_gene$V1)

setdiff(top_gene,rownames(counts(dds))) #check if all genes of interest can be found in the rownames of the deseq object --> if not you will not be able to run the block of code. Character(0) or integer(0) is a what you want to see
```

```{r}
stat.test<-read.csv("FDR.csv")
stat.test$symbol<-factor(stat.test$symbol)
stat.test$group2<-as.factor(stat.test$group2)
stat.test$group1<-as.factor(stat.test$group1)
stat.test
```

```{r}
data_1 <- split(as.tibble(stat.test[,2:4]), as.factor(stat.test$symbol))
```
```{r}
dds$Treatment<-factor(dds$Treatment, levels = c("WT_VEH","WT_PCB6","WT_PCB30","GF_VEH","GF_PCB6","GF_PCB30"))
```


```{r message=FALSE}
plot_list<-list()
for (i in unique(1:length(top_gene))){
  gene <- top_gene[i]
  b<- plotCounts(dds, gene = gene, intgroup = "Treatment",normalized = TRUE, returnData = TRUE)
  z = max(b$count) + (max(b$count)*0.05)
  d <- ggplot(b, aes(factor(Treatment), count))+
    geom_violin(mapping = aes(x = Treatment, 
                              y = count, 
                              fill = Treatment))+
    #adding jitter to avoid overplotting
    geom_point(mapping = aes(x = Treatment, 
                             y = count, 
                             fill = Treatment, 
                             shape= Treatment), 
               size = 5, position = position_jitter(width = 0.3, height=0))+ 
    scale_y_continuous(expand = c(0,0) , limits = c(0,z+z*0.4)) +
    stat_summary(mapping = aes(x = Treatment, y = count), 
                 geom = 'crossbar', 
                 fun= 'mean', 
                 colour = 'black', 
                 width=0.2)+
  scale_fill_manual(values = c("#999900", "#FF9933", "#3399FF", "#9933FF","#666666","#FF66CC")) +
  scale_shape_manual(values = c(19, 15, 17, 18,25,16)) +
  labs(x = NULL, y = "Normalized counts")+ # changes the y axis label, removes x axis label
  theme_classic(base_size = 20)+# changes the overall style of the plot
  ggtitle(paste0(res1$symbol[gene])) +
  theme(
    axis.text.x = element_text(colour = "black", size = 10, angle = 15),
    axis.text.y = element_text(colour = "black"))+
  stat_pvalue_manual(data_1[[i]], 
    y.position = z, step.increase = 0.2,
    label = "p = {scales::pvalue(p.adj)}", hide.ns = TRUE
    )
  plot_list[[gene]] <- d
}

head(plot_list)
```


```{r warning=FALSE}
# Export into pdf: display multiple plots on the same page
ggexport(
  plotlist = plot_list, filename = "gene_plot.pdf", 
  ncol = 1, nrow = 1, height = 7, width = 7, res = 600,pointsize = 8
)
```

